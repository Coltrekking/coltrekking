<!DOCTYPE html>
<html>
	<head>
		<title>FireBase Auth</title>

		<script src="https://www.gstatic.com/firebasejs/3.7.1/firebase.js"></script>
		<script src="https://apis.google.com/js/platform.js" async defer></script>
		<script>
			var provider = new firebase.auth.GoogleAuthProvider();
			var user;
			var url;
			var xmlhttp = new XMLHttpRequest();
			var userInfo = new Object();
			// Initialize Firebase
			var config = {
				apiKey: "AIzaSyDWuZXZioUNujSBLLOtH1tRF8IWCIqMH4g",
				authDomain: "coltrekking-b81da.firebaseapp.com",
				databaseURL: "https://coltrekking-b81da.firebaseio.com",
				storageBucket: "coltrekking-b81da.appspot.com",
				messagingSenderId: "1020694218506"
			};
			firebase.initializeApp(config);

			//Quando a pagina carrega
			window.onload = function(){
				initApp();
			}

			//Sign In
			function signIn(){
				firebase.auth().signInWithRedirect(provider);
			}

			//Ao mudar de estado (logado/deslogado)
			firebase.auth().onAuthStateChanged(function(user) {
				if(user) {
					userInfo.name = user.displayName;
					userInfo.email = user.email;
					userInfo.photoURL = user.photoURL;
					userInfo.uid = user.uid;

					/*Manda userInfo para server*/
					url = "/postUser";
					xmlhttp.onreadystatechange = function(){
						if(xmlhttp.readyState == 4 && xmlhttp.status == 200){
						}
					};

					xmlhttp.open("POST", url, true);
					xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
					xmlhttp.send(JSON.stringify(userInfo));

					/*Redireciona para logged.html*/


					/*Mostra dados do usuario*/
					//Mostra imagem
					document.getElementById('userImage').src = userInfo.photoURL;
					document.getElementById('userImage').style.width = "50px";
					document.getElementById('userImage').style.height = "50px";
					//Mostra mensagem de boas vindas
					document.getElementById('welcomeMessage').innerHTML = "Bem Vindo " + userInfo.name;
				}
				else {

				}
				
				console.log(userInfo);
			});

			//Sign Out
			function signOut() {
				firebase.auth().signOut().then(function() {
					//SignOut bem-sucedido
					userInfo = null;
					user = null;
					console.log("Volte sempre!");
				}, function(error) {
					//Deu ruim
				});
			}

			function initApp(){
				//Firebase sign in stuff
				firebase.auth().getRedirectResult().then(function(result) {
					console.log("ENTREI");

					if(result.credential) {
						var token = result.credential.accessToken;
					}

					//Info do usuario logado
					user = result.user;
				}).catch(function(error) {
					//Aqui cuida dos erros
					var errorCode = error.code;
					var errorMessage = error.message;

					//O email do usuario logado
					var email = error.email;
					//Tipo de credencial do FireBase usada
					var credential = error.credential;
				});
			}

		</script>
	</head>

	<body>
		<h1>FIREBASE</h1>
		<form action="/redirectLogin" method="get">
			<input type="submit" value="SignIn" name="signin" onclick="signIn();" >
		</form>
		<form action="/signout" method="get">
			<input type="submit" value="SignOut" name="signout" onclick="signOut();" type="submit">
		</form>

		<div style="margin-top: 50px;">
			<img id="userImage" height="0px" width="0px" style="display: inline-block; border-radius: 100%;" hidden="true">
			<h2 id="welcomeMessage" style="display: inline-block;" hidden="true"></h4>
		</div>
	</body>
</html>