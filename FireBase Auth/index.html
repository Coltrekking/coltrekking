<!DOCTYPE html>
<html>
	<head>
		<title>FireBase Auth</title>

		<script src="https://www.gstatic.com/firebasejs/3.7.1/firebase.js"></script>
		<script src="https://apis.google.com/js/platform.js" async defer></script>
		<meta name="google-signin-client_id" content="436699561525-24tmevumrhqj4dct2rlcukesubat6ugl.apps.googleusercontent.com">
		
		<script>
			var googleProvider = new firebase.auth.GoogleAuthProvider();
			var facebookProvider = new firebase.auth.FacebookAuthProvider();
			var user;
			var url;
			var xmlhttp = new XMLHttpRequest();
			var userInfo = new Object();
			// Initialize Firebase
			var config = {
				apiKey: "AIzaSyDWuZXZioUNujSBLLOtH1tRF8IWCIqMH4g",
				authDomain: "coltrekking-b81da.firebaseapp.com",
				databaseURL: "https://coltrekking-b81da.firebaseio.com",
				storageBucket: "coltrekking-b81da.appspot.com",
				messagingSenderId: "1020694218506"
			};
			firebase.initializeApp(config);

			/***Quando a pagina carrega***/
			window.onload = function() {
				initApp();
			}

			/***Google Sign In***/
			function googleSignIn() {
				firebase.auth().signInWithRedirect(googleProvider);
				
				//Altera botao de login
				document.getElementById('loginGoogle').disabled = true;
				document.getElementById('loginGoogle').value = "Redirecting...";
			}

			/***Facebook Sign In***/
			function facebookSignIn() {
				facebookProvider.addScope('email');
				firebase.auth().signInWithRedirect(facebookProvider);
			}

			/***Inicializar App***/
			function initApp() {
				/*Ao mudar de estado (logado/deslogado)*/
				firebase.auth().onAuthStateChanged(function(user) {
					/*Se logou*/
					if(user) {
						//Seta info do usuario logado
						userInfo.Nome = user.displayName;
						userInfo.Email = user.email;
						userInfo.Foto = user.photoURL;
						userInfo.ID = user.uid;

						/*Manda userInfo para server*/
						url = "/postUser";
						xmlhttp.onreadystatechange = function() {
							if(xmlhttp.readyState == 4 && xmlhttp.status == 200) {
								/*Redireciona para logged.html*/
								window.location = xmlhttp.responseText;
							}
						};
						xmlhttp.open("POST", url, true);
						xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
						xmlhttp.send(JSON.stringify(userInfo));				
					}
					else {					
						console.log("Nao tem user");
					}					
				});

				/*Pega resultado de redirecionamento*/
				firebase.auth().getRedirectResult().then(function(result) {
					if(result.credential) {
						var token = result.credential.accessToken;
					}
					//Info do usuario logado
					user = result.user;

				}).catch(function(error) {
					//Aqui cuida dos erros
					var errorCode = error.code;
					//Erro de ja ter cadastrado com outro provider
					if(errorCode == 'auth/account-exists-with-different-credential') {
						alert("Ja tem cadastro");
					}

					var errorMessage = error.message;

					//O email do usuario logado
					var email = error.email;
					//Tipo de credencial do FireBase usada
					var credential = error.credential;
				});
			}

		</script>
	</head>

	<body>
		<h1>FIREBASE</h1>

		<input id="loginGoogle" type="button" value="Google Sign In" name="signin" onclick="googleSignIn();">

		<input id="loginFacebook" type="button" value="Facebook Sign In" name="signin" onclick="facebookSignIn();">

		<fb:login-button data-auto-logout-link="true" scope="public_profile,email" size="large"></fb:login-button>
	</body>
</html>