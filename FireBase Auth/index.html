<!DOCTYPE html>
<html>
	<head>
		<title>FireBase Auth</title>

		<script src="https://www.gstatic.com/firebasejs/3.7.1/firebase.js"></script>
		<script src="https://apis.google.com/js/platform.js" async defer></script>
		<script>
			var provider = new firebase.auth.GoogleAuthProvider();
			var user;
			var url;
			var xmlhttp = new XMLHttpRequest();
			var userInfo = new Object();
			// Initialize Firebase
			var config = {
				apiKey: "AIzaSyDWuZXZioUNujSBLLOtH1tRF8IWCIqMH4g",
				authDomain: "coltrekking-b81da.firebaseapp.com",
				databaseURL: "https://coltrekking-b81da.firebaseio.com",
				storageBucket: "coltrekking-b81da.appspot.com",
				messagingSenderId: "1020694218506"
			};
			firebase.initializeApp(config);

			/***Quando a pagina carrega***/
			window.onload = function(){
				initApp();
			}

			/***Sign In***/
			function signIn(){
				firebase.auth().signInWithRedirect(provider);
			}

			/***Ao mudar de estado (logado/deslogado)***/
			firebase.auth().onAuthStateChanged(function(user) {
				if(user) {
					userInfo.name = user.displayName;
					userInfo.email = user.email;
					userInfo.photoURL = user.photoURL;
					userInfo.uid = user.uid;

					/*Manda userInfo para server*/
					url = "/postUser";
					xmlhttp.onreadystatechange = function(){
						if(xmlhttp.readyState == 4 && xmlhttp.status == 200){
							/*Redireciona para logged.html*/
							window.location = "/redirectLogin";
						}
					};
					xmlhttp.open("POST", url, true);
					xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
					xmlhttp.send(JSON.stringify(userInfo));					
				}
				else {
					console.log("Nao tem user");
				}
				
				console.log(userInfo);
			});

			/***Inicializar App***/
			function initApp(){
				//Firebase sign in stuff
				firebase.auth().getRedirectResult().then(function(result) {
					if(result.credential) {
						var token = result.credential.accessToken;
					}
					//Info do usuario logado
					user = result.user;
				}).catch(function(error) {
					//Aqui cuida dos erros
					var errorCode = error.code;
					var errorMessage = error.message;

					//O email do usuario logado
					var email = error.email;
					//Tipo de credencial do FireBase usada
					var credential = error.credential;
				});
			}

		</script>
	</head>

	<body>
		<h1>FIREBASE</h1>
		<input type="button" value="SignIn" name="signin" onclick="signIn();">
	</body>
</html>